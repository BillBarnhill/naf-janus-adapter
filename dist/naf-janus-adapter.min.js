<<<<<<< HEAD
(function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a['default']}:function(){return a};return b.d(c,'a',c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p='',b(b.s=1)})([function(a,b,c){(function(d){function e(){var a;try{a=b.storage.debug}catch(a){}return!a&&'undefined'!=typeof d&&'env'in d&&(a=d.env.DEBUG),a}b=a.exports=c(4),b.log=function(){return'object'==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},b.formatArgs=function(a){var d=this.useColors;if(a[0]=(d?'%c':'')+this.namespace+(d?' %c':' ')+a[0]+(d?'%c ':' ')+'+'+b.humanize(this.diff),!!d){var e='color: '+this.color;a.splice(1,0,e,'color: inherit');var c=0,f=0;a[0].replace(/%[a-zA-Z%]/g,function(a){'%%'===a||(c++,'%c'===a&&(f=c))}),a.splice(f,0,e)}},b.save=function(a){try{null==a?b.storage.removeItem('debug'):b.storage.debug=a}catch(a){}},b.load=e,b.useColors=function(){return'undefined'!=typeof window&&window.process&&'renderer'===window.process.type||('undefined'!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:'undefined'!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||'undefined'!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||'undefined'!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&31<=parseInt(RegExp.$1,10)||'undefined'!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},b.storage='undefined'!=typeof chrome&&'undefined'!=typeof chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(a){}}(),b.colors=['#0000CC','#0000FF','#0033CC','#0033FF','#0066CC','#0066FF','#0099CC','#0099FF','#00CC00','#00CC33','#00CC66','#00CC99','#00CCCC','#00CCFF','#3300CC','#3300FF','#3333CC','#3333FF','#3366CC','#3366FF','#3399CC','#3399FF','#33CC00','#33CC33','#33CC66','#33CC99','#33CCCC','#33CCFF','#6600CC','#6600FF','#6633CC','#6633FF','#66CC00','#66CC33','#9900CC','#9900FF','#9933CC','#9933FF','#99CC00','#99CC33','#CC0000','#CC0033','#CC0066','#CC0099','#CC00CC','#CC00FF','#CC3300','#CC3333','#CC3366','#CC3399','#CC33CC','#CC33FF','#CC6600','#CC6633','#CC9900','#CC9933','#CCCC00','#CCCC33','#FF0000','#FF0033','#FF0066','#FF0099','#FF00CC','#FF00FF','#FF3300','#FF3333','#FF3366','#FF3399','#FF33CC','#FF33FF','#FF6600','#FF6633','#FF9900','#FF9933','#FFCC00','#FFCC33'],b.formatters.j=function(a){try{return JSON.stringify(a)}catch(a){return'[UnexpectedJSONParseError]: '+a.message}},b.enable(e())}).call(b,c(3))},function(a,b,c){function d(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}function e(a){var b=Promise.resolve();return function(){var c=Array.prototype.slice.call(arguments);b=b.then(()=>a.apply(this,c))}}function f(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}var g=c(2),h=c(0)('naf-janus-adapter:debug'),i=c(0)('naf-janus-adapter:warn'),j=c(0)('naf-janus-adapter:error');const k=(()=>{const a=document.createElement('video');return''!==a.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')})(),l={iceServers:[{urls:'stun:stun1.l.google.com:19302'},{urls:'stun:stun2.l.google.com:19302'}]};class m{constructor(){this.room=null,this.userId=f()+'',this.serverUrl=null,this.webRtcOptions={},this.ws=null,this.session=null,this.initialReconnectionDelay=1e3*Math.random(),this.reconnectionDelay=this.initialReconnectionDelay,this.reconnectionTimeout=null,this.maxReconnectionAttempts=10,this.reconnectionAttempts=0,this.publisher=null,this.occupants={},this.mediaStreams={},this.localMediaStream=null,this.pendingMediaRequests=new Map,this.frozenUpdates=new Map,this.timeOffsets=[],this.serverTimeRequests=0,this.avgTimeOffset=0,this.onWebsocketOpen=this.onWebsocketOpen.bind(this),this.onWebsocketClose=this.onWebsocketClose.bind(this),this.onWebsocketMessage=this.onWebsocketMessage.bind(this),this.onDataChannelMessage=this.onDataChannelMessage.bind(this)}setServerUrl(a){this.serverUrl=a}setApp(){}setRoom(a){this.room=a}setWebRtcOptions(a){this.webRtcOptions=a}setServerConnectListeners(a,b){this.connectSuccess=a,this.connectFailure=b}setRoomOccupantListener(a){this.onOccupantsChanged=a}setDataChannelListeners(a,b,c){this.onOccupantConnected=a,this.onOccupantDisconnected=b,this.onOccupantMessage=c}setReconnectionListeners(a,b,c){this.onReconnecting=a,this.onReconnected=b,this.onReconnectionError=c}connect(){h(`connecting to ${this.serverUrl}`);const a=new Promise((a,b)=>{this.ws=new WebSocket(this.serverUrl,'janus-protocol'),this.session=new g.JanusSession(this.ws.send.bind(this.ws));let c;const d=()=>{b(j)};this.ws.addEventListener('close',this.onWebsocketClose),this.ws.addEventListener('message',this.onWebsocketMessage),c=()=>{this.ws.removeEventListener('open',c),this.ws.removeEventListener('error',d),this.onWebsocketOpen().then(a).catch(b)},this.ws.addEventListener('open',c)});return Promise.all([a,this.updateTimeOffset()])}disconnect(){h(`disconnecting`),clearTimeout(this.reconnectionTimeout),this.removeAllOccupants(),this.publisher&&(this.publisher.conn.close(),this.publisher=null),this.session&&(this.session.dispose(),this.session=null),this.ws&&(this.ws.removeEventListener('open',this.onWebsocketOpen),this.ws.removeEventListener('close',this.onWebsocketClose),this.ws.removeEventListener('message',this.onWebsocketMessage),this.ws.close(),this.ws=null)}isDisconnected(){return null===this.ws}onWebsocketOpen(){var a=this;return d(function*(){yield a.session.create(),a.publisher=yield a.createPublisher(),a.connectSuccess(a.userId),yield Promise.all(a.publisher.initialOccupants.map(a.addOccupant.bind(a)))})()}onWebsocketClose(a){a.code===1e3||(this.onReconnecting&&this.onReconnecting(this.reconnectionDelay),this.reconnectionTimeout=setTimeout(()=>this.reconnect(),this.reconnectionDelay))}reconnect(){this.disconnect(),this.connect().then(()=>{this.reconnectionDelay=this.initialReconnectionDelay,this.reconnectionAttempts=0,this.onReconnected&&this.onReconnected()}).catch(()=>(this.reconnectionDelay+=1e3,this.reconnectionAttempts++,this.reconnectionAttempts>this.maxReconnectionAttempts&&this.onReconnectionError?this.onReconnectionError(new Error('Connection could not be reestablished, exceeded maximum number of reconnection attempts.')):void(this.onReconnecting&&this.onReconnecting(this.reconnectionDelay),this.reconnectionTimeout=setTimeout(()=>this.reconnect(),this.reconnectionDelay))))}onWebsocketMessage(a){this.session.receive(JSON.parse(a.data))}addOccupant(a){var b=this;return d(function*(){var c=yield b.createSubscriber(a);return b.occupants[a]=c,b.setMediaStream(a,c.mediaStream),b.onOccupantConnected(a),b.onOccupantsChanged(b.occupants),c})()}removeAllOccupants(){for(const a of Object.getOwnPropertyNames(this.occupants))this.removeOccupant(a)}removeOccupant(a){if(this.occupants[a]){if(this.occupants[a]&&(this.occupants[a].conn.close(),delete this.occupants[a]),this.mediaStreams[a]&&delete this.mediaStreams[a],this.pendingMediaRequests.has(a)){const b='The user disconnected before the media stream was resolved.';this.pendingMediaRequests.get(a).audio.reject(b),this.pendingMediaRequests.get(a).video.reject(b),this.pendingMediaRequests.delete(a)}this.onOccupantDisconnected(a),this.onOccupantsChanged(this.occupants)}}associate(b,a){b.addEventListener('icecandidate',(b)=>{a.sendTrickle(b.candidate||null).catch((a)=>j('Error trickling ICE: %o',a))}),b.addEventListener('negotiationneeded',e(()=>{h('Sending new offer for handle: %o',a);var c=b.createOffer(),d=c.then((a)=>b.setLocalDescription(a)),e=c.then((b)=>a.sendJsep(b)).then((a)=>b.setRemoteDescription(a.jsep));return Promise.all([d,e]).catch((a)=>j('Error negotiating offer: %o',a))})),a.on('event',e((c)=>{var d=c.jsep;if(d&&'offer'==d.type){h('Accepting new offer for handle: %o',a),d.sdp=this.configureSubscriberSdp(d.sdp);var e=b.setRemoteDescription(d).then(()=>b.createAnswer()),f=e.then((c)=>b.setLocalDescription(c)),g=e.then((b)=>a.sendJsep(b));Promise.all([f,g]).catch((a)=>j('Error negotiating answer: %o',a))}}))}createPublisher(){var a=this;return d(function*(){var b=new g.JanusPluginHandle(a.session),c=new RTCPeerConnection(l);h('pub waiting for sfu'),yield b.attach('janus.plugin.sfu');var d=c.createDataChannel('reliable',{ordered:!0}),e=c.createDataChannel('unreliable',{ordered:!1,maxRetransmits:0});d.addEventListener('message',a.onDataChannelMessage),e.addEventListener('message',a.onDataChannelMessage),a.associate(c,b),h('pub waiting for webrtcup'),yield new Promise(function(a){return b.on('webrtcup',a)}),a.localMediaStream&&a.localMediaStream.getTracks().forEach(function(b){c.addTrack(b,a.localMediaStream)}),b.on('event',function(b){var c=b.plugindata.data;'join'==c.event&&c.room_id==a.room?a.addOccupant(c.user_id):'leave'==c.event&&c.room_id==a.room?a.removeOccupant(c.user_id):'blocked'==c.event?document.body.dispatchEvent(new CustomEvent('blocked',{detail:{clientId:c.by}})):'unblocked'==c.event&&document.body.dispatchEvent(new CustomEvent('unblocked',{detail:{clientId:c.by}}))}),h('pub waiting for join');var f=yield a.sendJoin(b,{notifications:!0,data:!0});if(!f.plugindata.data.success){const a=f.plugindata.data.error;throw console.error(a),a}var i=f.plugindata.data.response.users[a.room]||[];return h('publisher ready'),{handle:b,initialOccupants:i,reliableChannel:d,unreliableChannel:e,conn:c}})()}configureSubscriberSdp(a){return k?-1===navigator.userAgent.indexOf('Android')?a.replace('a=rtcp-fb:107 goog-remb\r\n','a=rtcp-fb:107 goog-remb\r\na=rtcp-fb:107 transport-cc\r\na=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\n'):a.replace('a=rtcp-fb:107 goog-remb\r\n','a=rtcp-fb:107 goog-remb\r\na=rtcp-fb:107 transport-cc\r\na=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\r\n'):-1===navigator.userAgent.indexOf('HeadlessChrome')?a:a.replace(/m=video[^]*m=/,'m=')}createSubscriber(a){var b=this;return d(function*(){var c=new g.JanusPluginHandle(b.session),d=new RTCPeerConnection(l);h('sub waiting for sfu'),yield c.attach('janus.plugin.sfu'),b.associate(d,c),h('sub waiting for join');yield b.sendJoin(c,{media:a});h('sub waiting for webrtcup'),yield new Promise(function(a){return c.on('webrtcup',a)});var e=new MediaStream,f=d.getReceivers();return f.forEach(function(a){a.track&&e.addTrack(a.track)}),0===e.getTracks().length&&(e=null),h('subscriber ready'),{handle:c,mediaStream:e,conn:d}})()}sendJoin(a,b){return a.sendMessage({kind:'join',room_id:this.room,user_id:this.userId,subscribe:b})}toggleFreeze(){this.frozen?this.unfreeze():this.freeze()}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1,this.flushPendingUpdates()}flushPendingUpdates(){for(const[a,b]of this.frozenUpdates)(!b.data.owner||this.occupants[b.data.owner])&&this.onOccupantMessage(null,b.dataType,b.data);this.frozenUpdates.clear()}storeMessage(a){const b=a.data.networkId;if(!this.frozenUpdates.has(b))this.frozenUpdates.set(b,a);else{const c=this.frozenUpdates.get(b);if(a.data.lastOwnerTime<c.data.lastOwnerTime||c.data.lastOwnerTime===a.data.lastOwnerTime&&c.data.owner>a.data.owner)return;'r'===a.dataType?this.frozenUpdates.set(b,a):Object.assign(c.data.components,a.data.components)}}onDataChannelMessage(a){var b=JSON.parse(a.data);h.enabled&&h(`DC in: ${a.data}`);b.dataType&&(this.frozen?this.storeMessage(b):this.onOccupantMessage(null,b.dataType,b.data))}shouldStartConnectionTo(){return!0}startStreamConnection(){}closeStreamConnection(){}getConnectStatus(a){return this.occupants[a]?NAF.adapters.IS_CONNECTED:NAF.adapters.NOT_CONNECTED}updateTimeOffset(){var a=this;return d(function*(){if(!a.isDisconnected()){const b=Date.now(),c=yield fetch(document.location.href,{method:'HEAD',cache:'no-cache'}),d=new Date(c.headers.get('Date')).getTime()+1e3/2,e=Date.now(),f=d+(e-b)/2-e;a.serverTimeRequests++,10>=a.serverTimeRequests?a.timeOffsets.push(f):a.timeOffsets[a.serverTimeRequests%10]=f,a.avgTimeOffset=a.timeOffsets.reduce(function(a,b){return a+=b},0)/a.timeOffsets.length,10<a.serverTimeRequests?(h(`new server time offset: ${a.avgTimeOffset}ms`),setTimeout(function(){return a.updateTimeOffset()},300000)):a.updateTimeOffset()}})()}getServerTime(){return Date.now()+this.avgTimeOffset}getMediaStream(a,b='audio'){if(this.mediaStreams[a])return h(`Already had ${b} for ${a}`),Promise.resolve(this.mediaStreams[a][b]);if(h(`Waiting on ${b} for ${a}`),!this.pendingMediaRequests.has(a)){this.pendingMediaRequests.set(a,{});const b=new Promise((b,c)=>{this.pendingMediaRequests.get(a).audio={resolve:b,reject:c}}),c=new Promise((b,c)=>{this.pendingMediaRequests.get(a).video={resolve:b,reject:c}});this.pendingMediaRequests.get(a).audio.promise=b,this.pendingMediaRequests.get(a).video.promise=c}return this.pendingMediaRequests.get(a)[b].promise}setMediaStream(a,b){const c=new MediaStream;b.getAudioTracks().forEach((a)=>c.addTrack(a));const d=new MediaStream;b.getVideoTracks().forEach((a)=>d.addTrack(a)),this.mediaStreams[a]={audio:c,video:d},this.pendingMediaRequests.has(a)&&(this.pendingMediaRequests.get(a).audio.resolve(c),this.pendingMediaRequests.get(a).video.resolve(d))}setLocalMediaStream(a){if(this.publisher&&this.publisher.conn){var b=this.publisher.conn.getSenders(),c=[];a.getTracks().forEach((d)=>{var e=b.find((a)=>null!=a.track&&a.track.kind==d.kind);null==e?c.push(this.publisher.conn.addTrack(d,a)):(e.replaceTrack?(e.replaceTrack(d),e.track.enabled=!0):(a.removeTrack(e.track),a.addTrack(d),d.enabled=!0),c.push(e))}),b.forEach((a)=>{c.includes(a)||(a.track.enabled=!1)})}this.localMediaStream=a,this.setMediaStream(this.userId,a)}enableMicrophone(a){this.publisher&&this.publisher.conn&&this.publisher.conn.getSenders().forEach((b)=>{'audio'==b.track.kind&&(b.track.enabled=a)})}sendData(a,b,c){return this.publisher?void this.publisher.unreliableChannel.send(JSON.stringify({clientId:a,dataType:b,data:c})):console.warn('sendData called without a publisher')}sendDataGuaranteed(a,b,c){return this.publisher?void this.publisher.reliableChannel.send(JSON.stringify({clientId:a,dataType:b,data:c})):console.warn('sendDataGuaranteed called without a publisher')}broadcastData(a,b){return this.publisher?void this.publisher.unreliableChannel.send(JSON.stringify({dataType:a,data:b})):console.warn('broadcastData called without a publisher')}broadcastDataGuaranteed(a,b){return this.publisher?void this.publisher.reliableChannel.send(JSON.stringify({dataType:a,data:b})):console.warn('broadcastDataGuaranteed called without a publisher')}block(a){return this.publisher.handle.sendMessage({kind:'block',whom:a}).then(()=>{document.body.dispatchEvent(new CustomEvent('blocked',{detail:{clientId:a}}))})}unblock(a){return this.publisher.handle.sendMessage({kind:'unblock',whom:a}).then(()=>{document.body.dispatchEvent(new CustomEvent('unblocked',{detail:{clientId:a}}))})}}NAF.adapters.register('janus',m),a.exports=m},function(a){function b(a){this.session=a,this.id=void 0}function c(a,b){this.output=a,this.id=void 0,this.nextTxId=0,this.txns={},this.eventHandlers={},this.options=Object.assign({verbose:!1,timeoutMs:1e4,keepaliveMs:3e4},b)}b.prototype.attach=function(a){return this.session.send('attach',{plugin:a,"force-bundle":!0,"force-rtcp-mux":!0}).then((a)=>(this.id=a.data.id,a))},b.prototype.detach=function(){return this.send('detach')},b.prototype.on=function(a,b){return this.session.on(a,(a)=>{a.sender==this.id&&b(a)})},b.prototype.send=function(a,b){return this.session.send(a,Object.assign({handle_id:this.id},b))},b.prototype.sendMessage=function(a){return this.send('message',{body:a})},b.prototype.sendJsep=function(a){return this.send('message',{body:{},jsep:a})},b.prototype.sendTrickle=function(a){return this.send('trickle',{candidate:a})},c.prototype.create=function(){return this.send('create').then((a)=>(this.id=a.data.id,a))},c.prototype.destroy=function(){return this.send('destroy').then((a)=>(this.dispose(),a))},c.prototype.dispose=function(){for(var a in this._killKeepalive(),this.eventHandlers={},this.txns)if(this.txns.hasOwnProperty(a)){var b=this.txns[a];clearTimeout(b.timeout),b.reject(new Error('Janus session was disposed.')),delete this.txns[a]}},c.prototype.isError=function(a){return'error'===a.janus},c.prototype.on=function(a,b){var c=this.eventHandlers[a];null==c&&(c=this.eventHandlers[a]=[]),c.push(b)},c.prototype.receive=function(a){this.options.verbose&&this._logIncoming(a),a.session_id!=this.id&&console.warn('Incorrect session ID received in Janus signalling message: was '+a.session_id+', expected '+this.id+'.');var b=a.janus,c=this.eventHandlers[b];if(null!=c)for(var d=0;d<c.length;d++)c[d](a);if(null!=a.transaction){var e=this.txns[a.transaction];if(null==e)return;if('ack'===b&&'message'==e.type)return;clearTimeout(e.timeout),delete this.txns[a.transaction],(this.isError(a)?e.reject:e.resolve)(a)}},c.prototype.send=function(a,b){return b=Object.assign({transaction:(this.nextTxId++).toString()},b),new Promise((c,d)=>{var e=null;this.options.timeoutMs&&(e=setTimeout(()=>{delete this.txns[b.transaction],d(new Error('Signalling transaction with txid '+b.transaction+' timed out.'))},this.options.timeoutMs)),this.txns[b.transaction]={resolve:c,reject:d,timeout:e,type:a},this._transmit(a,b)})},c.prototype._transmit=function(a,b){b=Object.assign({janus:a},b),null!=this.id&&(b=Object.assign({session_id:this.id},b)),this.options.verbose&&this._logOutgoing(b),this.output(JSON.stringify(b)),this._resetKeepalive()},c.prototype._logOutgoing=function(a){var b=a.janus;'message'===b&&a.jsep&&(b=a.jsep.type);var c='> Outgoing Janus '+(b||'signal')+' (#'+a.transaction+'): ';console.debug('%c'+c,'color: #040',a)},c.prototype._logIncoming=function(a){var b=a.janus,c=a.transaction?'< Incoming Janus '+(b||'signal')+' (#'+a.transaction+'): ':'< Incoming Janus '+(b||'signal')+': ';console.debug('%c'+c,'color: #004',a)},c.prototype._sendKeepalive=function(){return this.send('keepalive')},c.prototype._killKeepalive=function(){clearTimeout(this.keepaliveTimeout)},c.prototype._resetKeepalive=function(){this._killKeepalive(),this.options.keepaliveMs&&(this.keepaliveTimeout=setTimeout(()=>{this._sendKeepalive().catch((a)=>console.error('Error received from keepalive: ',a))},this.options.keepaliveMs))},a.exports={JanusPluginHandle:b,JanusSession:c}},function(a){function b(){throw new Error('setTimeout has not been defined')}function c(){throw new Error('clearTimeout has not been defined')}function d(a){if(j===setTimeout)return setTimeout(a,0);if((j===b||!j)&&setTimeout)return j=setTimeout,setTimeout(a,0);try{return j(a,0)}catch(b){try{return j.call(null,a,0)}catch(b){return j.call(this,a,0)}}}function e(a){if(k===clearTimeout)return clearTimeout(a);if((k===c||!k)&&clearTimeout)return k=clearTimeout,clearTimeout(a);try{return k(a)}catch(b){try{return k.call(null,a)}catch(b){return k.call(this,a)}}}function f(){o&&m&&(o=!1,m.length?n=m.concat(n):p=-1,n.length&&g())}function g(){if(!o){var a=d(f);o=!0;for(var b=n.length;b;){for(m=n,n=[];++p<b;)m&&m[p].run();p=-1,b=n.length}m=null,o=!1,e(a)}}function h(a,b){this.fun=a,this.array=b}function i(){}var j,k,l=a.exports={};(function(){try{j='function'==typeof setTimeout?setTimeout:b}catch(a){j=b}try{k='function'==typeof clearTimeout?clearTimeout:c}catch(a){k=c}})();var m,n=[],o=!1,p=-1;l.nextTick=function(a){var b=Array(arguments.length-1);if(1<arguments.length)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];n.push(new h(a,b)),1!==n.length||o||d(g)},h.prototype.run=function(){this.fun.apply(null,this.array)},l.title='browser',l.browser=!0,l.env={},l.argv=[],l.version='',l.versions={},l.on=i,l.addListener=i,l.once=i,l.off=i,l.removeListener=i,l.removeAllListeners=i,l.emit=i,l.prependListener=i,l.prependOnceListener=i,l.listeners=function(){return[]},l.binding=function(){throw new Error('process.binding is not supported')},l.cwd=function(){return'/'},l.chdir=function(){throw new Error('process.chdir is not supported')},l.umask=function(){return 0}},function(a,b,c){function d(a){var c,d=0;for(c in a)d=(d<<5)-d+a.charCodeAt(c),d|=0;return b.colors[Math.abs(d)%b.colors.length]}function e(a){function c(){if(c.enabled){var a=c,d=+new Date,f=d-(e||d);a.diff=f,a.prev=e,a.curr=d,e=d;for(var g=Array(arguments.length),h=0;h<g.length;h++)g[h]=arguments[h];g[0]=b.coerce(g[0]),'string'!=typeof g[0]&&g.unshift('%O');var i=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,function(c,d){if('%%'===c)return c;i++;var e=b.formatters[d];if('function'==typeof e){var f=g[i];c=e.call(a,f),g.splice(i,1),i--}return c}),b.formatArgs.call(a,g);var j=c.log||b.log||console.log.bind(console);j.apply(a,g)}}var e;return c.namespace=a,c.enabled=b.enabled(a),c.useColors=b.useColors(),c.color=d(a),c.destroy=f,'function'==typeof b.init&&b.init(c),b.instances.push(c),c}function f(){var a=b.instances.indexOf(this);return-1!==a&&(b.instances.splice(a,1),!0)}b=a.exports=e.debug=e['default']=e,b.coerce=function(a){return a instanceof Error?a.stack||a.message:a},b.disable=function(){b.enable('')},b.enable=function(a){b.save(a),b.names=[],b.skips=[];var c,d=('string'==typeof a?a:'').split(/[\s,]+/),e=d.length;for(c=0;c<e;c++)d[c]&&(a=d[c].replace(/\*/g,'.*?'),'-'===a[0]?b.skips.push(new RegExp('^'+a.substr(1)+'$')):b.names.push(new RegExp('^'+a+'$')));for(c=0;c<b.instances.length;c++){var f=b.instances[c];f.enabled=b.enabled(f.namespace)}},b.enabled=function(a){if('*'===a[a.length-1])return!0;var c,d;for(c=0,d=b.skips.length;c<d;c++)if(b.skips[c].test(a))return!1;for(c=0,d=b.names.length;c<d;c++)if(b.names[c].test(a))return!0;return!1},b.humanize=c(5),b.instances=[],b.names=[],b.skips=[],b.formatters={}},function(a){function b(a){if(a+='',!(100<a.length)){var b=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(a);if(b){var c=parseFloat(b[1]),e=(b[2]||'ms').toLowerCase();return'years'===e||'year'===e||'yrs'===e||'yr'===e||'y'===e?c*d:'days'===e||'day'===e||'d'===e?c*h:'hours'===e||'hour'===e||'hrs'===e||'hr'===e||'h'===e?c*j:'minutes'===e||'minute'===e||'mins'===e||'min'===e||'m'===e?c*i:'seconds'===e||'second'===e||'secs'===e||'sec'===e||'s'===e?c*g:'milliseconds'===e||'millisecond'===e||'msecs'===e||'msec'===e||'ms'===e?c:void 0}}}function c(a){var b=Math.round;return a>=h?b(a/h)+'d':a>=j?b(a/j)+'h':a>=i?b(a/i)+'m':a>=g?b(a/g)+'s':a+'ms'}function e(a){return f(a,h,'day')||f(a,j,'hour')||f(a,i,'minute')||f(a,g,'second')||a+' ms'}function f(a,b,c){return a<b?void 0:a<1.5*b?Math.floor(a/b)+' '+c:Math.ceil(a/b)+' '+c+'s'}var g=1e3,i=60*g,j=60*i,h=24*j,d=365.25*h;a.exports=function(a,d){d=d||{};var f=typeof a;if('string'==f&&0<a.length)return b(a);if('number'==f&&!1===isNaN(a))return d.long?e(a):c(a);throw new Error('val is not a non-empty string or a valid number. val='+JSON.stringify(a))}}]);
||||||| merged common ancestors
(function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a['default']}:function(){return a};return b.d(c,'a',c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p='',b(b.s=1)})([function(a,b,c){(function(d){function e(){var a;try{a=b.storage.debug}catch(a){}return!a&&'undefined'!=typeof d&&'env'in d&&(a=d.env.DEBUG),a}b=a.exports=c(4),b.log=function(){return'object'==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},b.formatArgs=function(a){var d=this.useColors;if(a[0]=(d?'%c':'')+this.namespace+(d?' %c':' ')+a[0]+(d?'%c ':' ')+'+'+b.humanize(this.diff),!!d){var e='color: '+this.color;a.splice(1,0,e,'color: inherit');var c=0,f=0;a[0].replace(/%[a-zA-Z%]/g,function(a){'%%'===a||(c++,'%c'===a&&(f=c))}),a.splice(f,0,e)}},b.save=function(a){try{null==a?b.storage.removeItem('debug'):b.storage.debug=a}catch(a){}},b.load=e,b.useColors=function(){return'undefined'!=typeof window&&window.process&&'renderer'===window.process.type||('undefined'!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:'undefined'!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||'undefined'!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||'undefined'!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&31<=parseInt(RegExp.$1,10)||'undefined'!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},b.storage='undefined'!=typeof chrome&&'undefined'!=typeof chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(a){}}(),b.colors=['#0000CC','#0000FF','#0033CC','#0033FF','#0066CC','#0066FF','#0099CC','#0099FF','#00CC00','#00CC33','#00CC66','#00CC99','#00CCCC','#00CCFF','#3300CC','#3300FF','#3333CC','#3333FF','#3366CC','#3366FF','#3399CC','#3399FF','#33CC00','#33CC33','#33CC66','#33CC99','#33CCCC','#33CCFF','#6600CC','#6600FF','#6633CC','#6633FF','#66CC00','#66CC33','#9900CC','#9900FF','#9933CC','#9933FF','#99CC00','#99CC33','#CC0000','#CC0033','#CC0066','#CC0099','#CC00CC','#CC00FF','#CC3300','#CC3333','#CC3366','#CC3399','#CC33CC','#CC33FF','#CC6600','#CC6633','#CC9900','#CC9933','#CCCC00','#CCCC33','#FF0000','#FF0033','#FF0066','#FF0099','#FF00CC','#FF00FF','#FF3300','#FF3333','#FF3366','#FF3399','#FF33CC','#FF33FF','#FF6600','#FF6633','#FF9900','#FF9933','#FFCC00','#FFCC33'],b.formatters.j=function(a){try{return JSON.stringify(a)}catch(a){return'[UnexpectedJSONParseError]: '+a.message}},b.enable(e())}).call(b,c(3))},function(a,b,c){function d(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}function e(a){var b=Promise.resolve();return function(){var c=Array.prototype.slice.call(arguments);b=b.then(()=>a.apply(this,c))}}function f(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}var g=c(2),h=c(0)('naf-janus-adapter:debug'),i=c(0)('naf-janus-adapter:warn'),j=c(0)('naf-janus-adapter:error');const k=(()=>{const a=document.createElement('video');return''!==a.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')})(),l={iceServers:[{urls:'stun:stun1.l.google.com:19302'},{urls:'stun:stun2.l.google.com:19302'}]};class m{constructor(){this.room=null,this.userId=f()+'',this.serverUrl=null,this.webRtcOptions={},this.ws=null,this.session=null,this.initialReconnectionDelay=1e3*Math.random(),this.reconnectionDelay=this.initialReconnectionDelay,this.reconnectionTimeout=null,this.maxReconnectionAttempts=10,this.reconnectionAttempts=0,this.publisher=null,this.occupants={},this.mediaStreams={},this.localMediaStream=null,this.pendingMediaRequests=new Map,this.frozenUpdates=new Map,this.timeOffsets=[],this.serverTimeRequests=0,this.avgTimeOffset=0,this.onWebsocketOpen=this.onWebsocketOpen.bind(this),this.onWebsocketClose=this.onWebsocketClose.bind(this),this.onWebsocketMessage=this.onWebsocketMessage.bind(this),this.onDataChannelMessage=this.onDataChannelMessage.bind(this)}setServerUrl(a){this.serverUrl=a}setApp(){}setRoom(a){this.room=a}setWebRtcOptions(a){this.webRtcOptions=a}setServerConnectListeners(a,b){this.connectSuccess=a,this.connectFailure=b}setRoomOccupantListener(a){this.onOccupantsChanged=a}setDataChannelListeners(a,b,c){this.onOccupantConnected=a,this.onOccupantDisconnected=b,this.onOccupantMessage=c}setReconnectionListeners(a,b,c){this.onReconnecting=a,this.onReconnected=b,this.onReconnectionError=c}connect(){h(`connecting to ${this.serverUrl}`);const a=new Promise((a,b)=>{this.ws=new WebSocket(this.serverUrl,'janus-protocol'),this.session=new g.JanusSession(this.ws.send.bind(this.ws));let c;const d=()=>{b(j)};this.ws.addEventListener('close',this.onWebsocketClose),this.ws.addEventListener('message',this.onWebsocketMessage),c=()=>{this.ws.removeEventListener('open',c),this.ws.removeEventListener('error',d),this.onWebsocketOpen().then(a).catch(b)},this.ws.addEventListener('open',c)});return Promise.all([a,this.updateTimeOffset()])}disconnect(){h(`disconnecting`),clearTimeout(this.reconnectionTimeout),this.removeAllOccupants(),this.publisher&&(this.publisher.conn.close(),this.publisher=null),this.session&&(this.session.dispose(),this.session=null),this.ws&&(this.ws.removeEventListener('open',this.onWebsocketOpen),this.ws.removeEventListener('close',this.onWebsocketClose),this.ws.removeEventListener('message',this.onWebsocketMessage),this.ws.close(),this.ws=null)}isDisconnected(){return null===this.ws}onWebsocketOpen(){var a=this;return d(function*(){yield a.session.create(),a.publisher=yield a.createPublisher(),a.connectSuccess(a.userId),yield Promise.all(a.publisher.initialOccupants.map(a.addOccupant.bind(a)))})()}onWebsocketClose(a){a.code===1e3||(this.onReconnecting&&this.onReconnecting(this.reconnectionDelay),this.reconnectionTimeout=setTimeout(()=>this.reconnect(),this.reconnectionDelay))}reconnect(){this.disconnect(),this.connect().then(()=>{this.reconnectionDelay=this.initialReconnectionDelay,this.reconnectionAttempts=0,this.onReconnected&&this.onReconnected()}).catch(()=>(this.reconnectionDelay+=1e3,this.reconnectionAttempts++,this.reconnectionAttempts>this.maxReconnectionAttempts&&this.onReconnectionError?this.onReconnectionError(new Error('Connection could not be reestablished, exceeded maximum number of reconnection attempts.')):void(this.onReconnecting&&this.onReconnecting(this.reconnectionDelay),this.reconnectionTimeout=setTimeout(()=>this.reconnect(),this.reconnectionDelay))))}onWebsocketMessage(a){this.session.receive(JSON.parse(a.data))}addOccupant(a){var b=this;return d(function*(){var c=yield b.createSubscriber(a);return b.occupants[a]=c,b.setMediaStream(a,c.mediaStream),b.onOccupantConnected(a),b.onOccupantsChanged(b.occupants),c})()}removeAllOccupants(){for(const a of Object.getOwnPropertyNames(this.occupants))this.removeOccupant(a)}removeOccupant(a){if(this.occupants[a]){if(this.occupants[a]&&(this.occupants[a].conn.close(),delete this.occupants[a]),this.mediaStreams[a]&&delete this.mediaStreams[a],this.pendingMediaRequests.has(a)){const b='The user disconnected before the media stream was resolved.';this.pendingMediaRequests.get(a).audio.reject(b),this.pendingMediaRequests.get(a).video.reject(b),this.pendingMediaRequests.delete(a)}this.onOccupantDisconnected(a),this.onOccupantsChanged(this.occupants)}}associate(b,a){b.addEventListener('icecandidate',(b)=>{a.sendTrickle(b.candidate||null).catch((a)=>j('Error trickling ICE: %o',a))}),b.addEventListener('negotiationneeded',e(()=>{h('Sending new offer for handle: %o',a);var c=b.createOffer(),d=c.then((a)=>b.setLocalDescription(a)),e=c.then((b)=>a.sendJsep(b)).then((a)=>b.setRemoteDescription(a.jsep));return Promise.all([d,e]).catch((a)=>j('Error negotiating offer: %o',a))})),a.on('event',e((c)=>{var d=c.jsep;if(d&&'offer'==d.type){h('Accepting new offer for handle: %o',a),d.sdp=this.configureSubscriberSdp(d.sdp);var e=b.setRemoteDescription(d).then(()=>b.createAnswer()),f=e.then((c)=>b.setLocalDescription(c)),g=e.then((b)=>a.sendJsep(b));Promise.all([f,g]).catch((a)=>j('Error negotiating answer: %o',a))}}))}createPublisher(){var a=this;return d(function*(){var b=new g.JanusPluginHandle(a.session),c=new RTCPeerConnection(l);h('pub waiting for sfu'),yield b.attach('janus.plugin.sfu');var d=c.createDataChannel('reliable',{ordered:!0}),e=c.createDataChannel('unreliable',{ordered:!1,maxRetransmits:0});d.addEventListener('message',a.onDataChannelMessage),e.addEventListener('message',a.onDataChannelMessage),a.associate(c,b),h('pub waiting for webrtcup'),yield new Promise(function(a){return b.on('webrtcup',a)}),a.localMediaStream&&a.localMediaStream.getTracks().forEach(function(b){c.addTrack(b,a.localMediaStream)}),b.on('event',function(b){var c=b.plugindata.data;'join'==c.event&&c.room_id==a.room?a.addOccupant(c.user_id):'leave'==c.event&&c.room_id==a.room?a.removeOccupant(c.user_id):'blocked'==c.event?document.body.dispatchEvent(new CustomEvent('blocked',{detail:{clientId:c.by}})):'unblocked'==c.event&&document.body.dispatchEvent(new CustomEvent('unblocked',{detail:{clientId:c.by}}))}),h('pub waiting for join');var f=yield a.sendJoin(b,{notifications:!0,data:!0});if(!f.plugindata.data.success){const a=f.plugindata.data.error;throw console.error(a),a}var i=f.plugindata.data.response.users[a.room]||[];return h('publisher ready'),{handle:b,initialOccupants:i,reliableChannel:d,unreliableChannel:e,conn:c}})()}configureSubscriberSdp(a){return k?-1===navigator.userAgent.indexOf('Android')?a.replace('a=rtcp-fb:107 goog-remb\r\n','a=rtcp-fb:107 goog-remb\r\na=rtcp-fb:107 transport-cc\r\na=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\n'):a.replace('a=rtcp-fb:107 goog-remb\r\n','a=rtcp-fb:107 goog-remb\r\na=rtcp-fb:107 transport-cc\r\na=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\r\n'):-1===navigator.userAgent.indexOf('HeadlessChrome')?a:a.replace(/m=video[^]*m=/,'m=')}createSubscriber(a){var b=this;return d(function*(){var c=new g.JanusPluginHandle(b.session),d=new RTCPeerConnection(l);h('sub waiting for sfu'),yield c.attach('janus.plugin.sfu'),b.associate(d,c),h('sub waiting for join');yield b.sendJoin(c,{media:a});h('sub waiting for webrtcup'),yield new Promise(function(a){return c.on('webrtcup',a)});var e=new MediaStream,f=d.getReceivers();return f.forEach(function(a){a.track&&e.addTrack(a.track)}),0===e.getTracks().length&&(e=null),h('subscriber ready'),{handle:c,mediaStream:e,conn:d}})()}sendJoin(a,b){return a.sendMessage({kind:'join',room_id:this.room,user_id:this.userId,subscribe:b})}toggleFreeze(){this.frozen?this.unfreeze():this.freeze()}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1,this.flushPendingUpdates()}flushPendingUpdates(){for(const[a,b]of this.frozenUpdates)(!b.data.owner||this.occupants[b.data.owner])&&this.onOccupantMessage(null,b.dataType,b.data);this.frozenUpdates.clear()}storeMessage(a){const b=a.data.networkId;if(!this.frozenUpdates.has(b))this.frozenUpdates.set(b,a);else{const c=this.frozenUpdates.get(b);if(a.data.lastOwnerTime<c.data.lastOwnerTime||c.data.lastOwnerTime===a.data.lastOwnerTime&&c.data.owner>a.data.owner)return;'r'===a.dataType?this.frozenUpdates.set(b,a):Object.assign(c.data.components,a.data.components)}}onDataChannelMessage(a){var b=JSON.parse(a.data);b.dataType&&(this.frozen?this.storeMessage(b):this.onOccupantMessage(null,b.dataType,b.data))}shouldStartConnectionTo(){return!0}startStreamConnection(){}closeStreamConnection(){}getConnectStatus(a){return this.occupants[a]?NAF.adapters.IS_CONNECTED:NAF.adapters.NOT_CONNECTED}updateTimeOffset(){var a=this;return d(function*(){if(!a.isDisconnected()){const b=Date.now(),c=yield fetch(document.location.href,{method:'HEAD',cache:'no-cache'}),d=new Date(c.headers.get('Date')).getTime()+1e3/2,e=Date.now(),f=d+(e-b)/2-e;a.serverTimeRequests++,10>=a.serverTimeRequests?a.timeOffsets.push(f):a.timeOffsets[a.serverTimeRequests%10]=f,a.avgTimeOffset=a.timeOffsets.reduce(function(a,b){return a+=b},0)/a.timeOffsets.length,10<a.serverTimeRequests?(h(`new server time offset: ${a.avgTimeOffset}ms`),setTimeout(function(){return a.updateTimeOffset()},300000)):a.updateTimeOffset()}})()}getServerTime(){return Date.now()+this.avgTimeOffset}getMediaStream(a,b='audio'){if(this.mediaStreams[a])return h(`Already had ${b} for ${a}`),Promise.resolve(this.mediaStreams[a][b]);if(h(`Waiting on ${b} for ${a}`),!this.pendingMediaRequests.has(a)){this.pendingMediaRequests.set(a,{});const b=new Promise((b,c)=>{this.pendingMediaRequests.get(a).audio={resolve:b,reject:c}}),c=new Promise((b,c)=>{this.pendingMediaRequests.get(a).video={resolve:b,reject:c}});this.pendingMediaRequests.get(a).audio.promise=b,this.pendingMediaRequests.get(a).video.promise=c}return this.pendingMediaRequests.get(a)[b].promise}setMediaStream(a,b){const c=new MediaStream;b.getAudioTracks().forEach((a)=>c.addTrack(a));const d=new MediaStream;b.getVideoTracks().forEach((a)=>d.addTrack(a)),this.mediaStreams[a]={audio:c,video:d},this.pendingMediaRequests.has(a)&&(this.pendingMediaRequests.get(a).audio.resolve(c),this.pendingMediaRequests.get(a).video.resolve(d))}setLocalMediaStream(a){if(this.publisher&&this.publisher.conn){var b=this.publisher.conn.getSenders(),c=[];a.getTracks().forEach((d)=>{var e=b.find((a)=>null!=a.track&&a.track.kind==d.kind);null==e?c.push(this.publisher.conn.addTrack(d,a)):(e.replaceTrack?(e.replaceTrack(d),e.track.enabled=!0):(a.removeTrack(e.track),a.addTrack(d),d.enabled=!0),c.push(e))}),b.forEach((a)=>{c.includes(a)||(a.track.enabled=!1)})}this.localMediaStream=a,this.setMediaStream(this.userId,a)}enableMicrophone(a){this.publisher&&this.publisher.conn&&this.publisher.conn.getSenders().forEach((b)=>{'audio'==b.track.kind&&(b.track.enabled=a)})}sendData(a,b,c){return this.publisher?void this.publisher.unreliableChannel.send(JSON.stringify({clientId:a,dataType:b,data:c})):console.warn('sendData called without a publisher')}sendDataGuaranteed(a,b,c){return this.publisher?void this.publisher.reliableChannel.send(JSON.stringify({clientId:a,dataType:b,data:c})):console.warn('sendDataGuaranteed called without a publisher')}broadcastData(a,b){return this.publisher?void this.publisher.unreliableChannel.send(JSON.stringify({dataType:a,data:b})):console.warn('broadcastData called without a publisher')}broadcastDataGuaranteed(a,b){return this.publisher?void this.publisher.reliableChannel.send(JSON.stringify({dataType:a,data:b})):console.warn('broadcastDataGuaranteed called without a publisher')}block(a){return this.publisher.handle.sendMessage({kind:'block',whom:a}).then(()=>{document.body.dispatchEvent(new CustomEvent('blocked',{detail:{clientId:a}}))})}unblock(a){return this.publisher.handle.sendMessage({kind:'unblock',whom:a}).then(()=>{document.body.dispatchEvent(new CustomEvent('unblocked',{detail:{clientId:a}}))})}}NAF.adapters.register('janus',m),a.exports=m},function(a){function b(a){this.session=a,this.id=void 0}function c(a,b){this.output=a,this.id=void 0,this.nextTxId=0,this.txns={},this.eventHandlers={},this.options=Object.assign({verbose:!1,timeoutMs:1e4,keepaliveMs:3e4},b)}b.prototype.attach=function(a){return this.session.send('attach',{plugin:a,"force-bundle":!0,"force-rtcp-mux":!0}).then((a)=>(this.id=a.data.id,a))},b.prototype.detach=function(){return this.send('detach')},b.prototype.on=function(a,b){return this.session.on(a,(a)=>{a.sender==this.id&&b(a)})},b.prototype.send=function(a,b){return this.session.send(a,Object.assign({handle_id:this.id},b))},b.prototype.sendMessage=function(a){return this.send('message',{body:a})},b.prototype.sendJsep=function(a){return this.send('message',{body:{},jsep:a})},b.prototype.sendTrickle=function(a){return this.send('trickle',{candidate:a})},c.prototype.create=function(){return this.send('create').then((a)=>(this.id=a.data.id,a))},c.prototype.destroy=function(){return this.send('destroy').then((a)=>(this.dispose(),a))},c.prototype.dispose=function(){for(var a in this._killKeepalive(),this.eventHandlers={},this.txns)if(this.txns.hasOwnProperty(a)){var b=this.txns[a];clearTimeout(b.timeout),b.reject(new Error('Janus session was disposed.')),delete this.txns[a]}},c.prototype.isError=function(a){return'error'===a.janus},c.prototype.on=function(a,b){var c=this.eventHandlers[a];null==c&&(c=this.eventHandlers[a]=[]),c.push(b)},c.prototype.receive=function(a){this.options.verbose&&this._logIncoming(a),a.session_id!=this.id&&console.warn('Incorrect session ID received in Janus signalling message: was '+a.session_id+', expected '+this.id+'.');var b=a.janus,c=this.eventHandlers[b];if(null!=c)for(var d=0;d<c.length;d++)c[d](a);if(null!=a.transaction){var e=this.txns[a.transaction];if(null==e)return;if('ack'===b&&'message'==e.type)return;clearTimeout(e.timeout),delete this.txns[a.transaction],(this.isError(a)?e.reject:e.resolve)(a)}},c.prototype.send=function(a,b){return b=Object.assign({transaction:(this.nextTxId++).toString()},b),new Promise((c,d)=>{var e=null;this.options.timeoutMs&&(e=setTimeout(()=>{delete this.txns[b.transaction],d(new Error('Signalling transaction with txid '+b.transaction+' timed out.'))},this.options.timeoutMs)),this.txns[b.transaction]={resolve:c,reject:d,timeout:e,type:a},this._transmit(a,b)})},c.prototype._transmit=function(a,b){b=Object.assign({janus:a},b),null!=this.id&&(b=Object.assign({session_id:this.id},b)),this.options.verbose&&this._logOutgoing(b),this.output(JSON.stringify(b)),this._resetKeepalive()},c.prototype._logOutgoing=function(a){var b=a.janus;'message'===b&&a.jsep&&(b=a.jsep.type);var c='> Outgoing Janus '+(b||'signal')+' (#'+a.transaction+'): ';console.debug('%c'+c,'color: #040',a)},c.prototype._logIncoming=function(a){var b=a.janus,c=a.transaction?'< Incoming Janus '+(b||'signal')+' (#'+a.transaction+'): ':'< Incoming Janus '+(b||'signal')+': ';console.debug('%c'+c,'color: #004',a)},c.prototype._sendKeepalive=function(){return this.send('keepalive')},c.prototype._killKeepalive=function(){clearTimeout(this.keepaliveTimeout)},c.prototype._resetKeepalive=function(){this._killKeepalive(),this.options.keepaliveMs&&(this.keepaliveTimeout=setTimeout(()=>{this._sendKeepalive().catch((a)=>console.error('Error received from keepalive: ',a))},this.options.keepaliveMs))},a.exports={JanusPluginHandle:b,JanusSession:c}},function(a){function b(){throw new Error('setTimeout has not been defined')}function c(){throw new Error('clearTimeout has not been defined')}function d(a){if(j===setTimeout)return setTimeout(a,0);if((j===b||!j)&&setTimeout)return j=setTimeout,setTimeout(a,0);try{return j(a,0)}catch(b){try{return j.call(null,a,0)}catch(b){return j.call(this,a,0)}}}function e(a){if(k===clearTimeout)return clearTimeout(a);if((k===c||!k)&&clearTimeout)return k=clearTimeout,clearTimeout(a);try{return k(a)}catch(b){try{return k.call(null,a)}catch(b){return k.call(this,a)}}}function f(){o&&m&&(o=!1,m.length?n=m.concat(n):p=-1,n.length&&g())}function g(){if(!o){var a=d(f);o=!0;for(var b=n.length;b;){for(m=n,n=[];++p<b;)m&&m[p].run();p=-1,b=n.length}m=null,o=!1,e(a)}}function h(a,b){this.fun=a,this.array=b}function i(){}var j,k,l=a.exports={};(function(){try{j='function'==typeof setTimeout?setTimeout:b}catch(a){j=b}try{k='function'==typeof clearTimeout?clearTimeout:c}catch(a){k=c}})();var m,n=[],o=!1,p=-1;l.nextTick=function(a){var b=Array(arguments.length-1);if(1<arguments.length)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];n.push(new h(a,b)),1!==n.length||o||d(g)},h.prototype.run=function(){this.fun.apply(null,this.array)},l.title='browser',l.browser=!0,l.env={},l.argv=[],l.version='',l.versions={},l.on=i,l.addListener=i,l.once=i,l.off=i,l.removeListener=i,l.removeAllListeners=i,l.emit=i,l.prependListener=i,l.prependOnceListener=i,l.listeners=function(){return[]},l.binding=function(){throw new Error('process.binding is not supported')},l.cwd=function(){return'/'},l.chdir=function(){throw new Error('process.chdir is not supported')},l.umask=function(){return 0}},function(a,b,c){function d(a){var c,d=0;for(c in a)d=(d<<5)-d+a.charCodeAt(c),d|=0;return b.colors[Math.abs(d)%b.colors.length]}function e(a){function c(){if(c.enabled){var a=c,d=+new Date,f=d-(e||d);a.diff=f,a.prev=e,a.curr=d,e=d;for(var g=Array(arguments.length),h=0;h<g.length;h++)g[h]=arguments[h];g[0]=b.coerce(g[0]),'string'!=typeof g[0]&&g.unshift('%O');var i=0;g[0]=g[0].replace(/%([a-zA-Z%])/g,function(c,d){if('%%'===c)return c;i++;var e=b.formatters[d];if('function'==typeof e){var f=g[i];c=e.call(a,f),g.splice(i,1),i--}return c}),b.formatArgs.call(a,g);var j=c.log||b.log||console.log.bind(console);j.apply(a,g)}}var e;return c.namespace=a,c.enabled=b.enabled(a),c.useColors=b.useColors(),c.color=d(a),c.destroy=f,'function'==typeof b.init&&b.init(c),b.instances.push(c),c}function f(){var a=b.instances.indexOf(this);return-1!==a&&(b.instances.splice(a,1),!0)}b=a.exports=e.debug=e['default']=e,b.coerce=function(a){return a instanceof Error?a.stack||a.message:a},b.disable=function(){b.enable('')},b.enable=function(a){b.save(a),b.names=[],b.skips=[];var c,d=('string'==typeof a?a:'').split(/[\s,]+/),e=d.length;for(c=0;c<e;c++)d[c]&&(a=d[c].replace(/\*/g,'.*?'),'-'===a[0]?b.skips.push(new RegExp('^'+a.substr(1)+'$')):b.names.push(new RegExp('^'+a+'$')));for(c=0;c<b.instances.length;c++){var f=b.instances[c];f.enabled=b.enabled(f.namespace)}},b.enabled=function(a){if('*'===a[a.length-1])return!0;var c,d;for(c=0,d=b.skips.length;c<d;c++)if(b.skips[c].test(a))return!1;for(c=0,d=b.names.length;c<d;c++)if(b.names[c].test(a))return!0;return!1},b.humanize=c(5),b.instances=[],b.names=[],b.skips=[],b.formatters={}},function(a){function b(a){if(a+='',!(100<a.length)){var b=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(a);if(b){var c=parseFloat(b[1]),e=(b[2]||'ms').toLowerCase();return'years'===e||'year'===e||'yrs'===e||'yr'===e||'y'===e?c*d:'days'===e||'day'===e||'d'===e?c*h:'hours'===e||'hour'===e||'hrs'===e||'hr'===e||'h'===e?c*j:'minutes'===e||'minute'===e||'mins'===e||'min'===e||'m'===e?c*i:'seconds'===e||'second'===e||'secs'===e||'sec'===e||'s'===e?c*g:'milliseconds'===e||'millisecond'===e||'msecs'===e||'msec'===e||'ms'===e?c:void 0}}}function c(a){var b=Math.round;return a>=h?b(a/h)+'d':a>=j?b(a/j)+'h':a>=i?b(a/i)+'m':a>=g?b(a/g)+'s':a+'ms'}function e(a){return f(a,h,'day')||f(a,j,'hour')||f(a,i,'minute')||f(a,g,'second')||a+' ms'}function f(a,b,c){return a<b?void 0:a<1.5*b?Math.floor(a/b)+' '+c:Math.ceil(a/b)+' '+c+'s'}var g=1e3,i=60*g,j=60*i,h=24*j,d=365.25*h;a.exports=function(a,d){d=d||{};var f=typeof a;if('string'==f&&0<a.length)return b(a);if('number'==f&&!1===isNaN(a))return d.long?e(a):c(a);throw new Error('val is not a non-empty string or a valid number. val='+JSON.stringify(a))}}]);
=======
!function(e){var t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t,n){(function(s){function i(){var e;try{e=t.storage.debug}catch(e){}return!e&&void 0!==s&&"env"in s&&(e=s.env.DEBUG),e}(t=e.exports=n(2)).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(e){var n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return;var s="color: "+this.color;e.splice(1,0,s,"color: inherit");var i=0,r=0;e[0].replace(/%[a-zA-Z%]/g,function(e){"%%"!==e&&"%c"===e&&(r=++i)}),e.splice(r,0,s)},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=i,t.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(i())}).call(this,n(3))},function(e,t){var n=1e3,s=60*n,i=60*s,r=24*i,o=365.25*r;function a(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}e.exports=function(e,t){t=t||{};var c=typeof e;if("string"===c&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var a=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return a*o;case"days":case"day":case"d":return a*r;case"hours":case"hour":case"hrs":case"hr":case"h":return a*i;case"minutes":case"minute":case"mins":case"min":case"m":return a*s;case"seconds":case"second":case"secs":case"sec":case"s":return a*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return a;default:return}}(e);if("number"===c&&!1===isNaN(e))return t.long?function(e){return a(e,r,"day")||a(e,i,"hour")||a(e,s,"minute")||a(e,n,"second")||e+" ms"}(e):function(e){if(e>=r)return Math.round(e/r)+"d";if(e>=i)return Math.round(e/i)+"h";if(e>=s)return Math.round(e/s)+"m";if(e>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,n){function s(e){var n;function s(){if(s.enabled){var e=s,i=+new Date,r=i-(n||i);e.diff=r,e.prev=n,e.curr=i,n=i;for(var o=new Array(arguments.length),a=0;a<o.length;a++)o[a]=arguments[a];o[0]=t.coerce(o[0]),"string"!=typeof o[0]&&o.unshift("%O");var c=0;o[0]=o[0].replace(/%([a-zA-Z%])/g,function(n,s){if("%%"===n)return n;c++;var i=t.formatters[s];if("function"==typeof i){var r=o[c];n=i.call(e,r),o.splice(c,1),c--}return n}),t.formatArgs.call(e,o),(s.log||t.log||console.log.bind(console)).apply(e,o)}}return s.namespace=e,s.enabled=t.enabled(e),s.useColors=t.useColors(),s.color=function(e){var n,s=0;for(n in e)s=(s<<5)-s+e.charCodeAt(n),s|=0;return t.colors[Math.abs(s)%t.colors.length]}(e),s.destroy=i,"function"==typeof t.init&&t.init(s),t.instances.push(s),s}function i(){var e=t.instances.indexOf(this);return-1!==e&&(t.instances.splice(e,1),!0)}(t=e.exports=s.debug=s.default=s).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){var n;t.save(e),t.names=[],t.skips=[];var s=("string"==typeof e?e:"").split(/[\s,]+/),i=s.length;for(n=0;n<i;n++)s[n]&&("-"===(e=s[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")));for(n=0;n<t.instances.length;n++){var r=t.instances[n];r.enabled=t.enabled(r.namespace)}},t.enabled=function(e){if("*"===e[e.length-1])return!0;var n,s;for(n=0,s=t.skips.length;n<s;n++)if(t.skips[n].test(e))return!1;for(n=0,s=t.names.length;n<s;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=n(1),t.instances=[],t.names=[],t.skips=[],t.formatters={}},function(e,t){var n,s,i=e.exports={};function r(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===r||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:r}catch(e){n=r}try{s="function"==typeof clearTimeout?clearTimeout:o}catch(e){s=o}}();var c,u=[],d=!1,l=-1;function h(){d&&c&&(d=!1,c.length?u=c.concat(u):l=-1,u.length&&p())}function p(){if(!d){var e=a(h);d=!0;for(var t=u.length;t;){for(c=u,u=[];++l<t;)c&&c[l].run();l=-1,t=u.length}c=null,d=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===o||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function m(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new f(e,t)),1!==u.length||d||a(p)},f.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t){function n(e){this.session=e,this.id=void 0}function s(e,t){this.output=e,this.id=void 0,this.nextTxId=0,this.txns={},this.eventHandlers={},this.options=Object.assign({verbose:!1,timeoutMs:1e4,keepaliveMs:3e4},t)}n.prototype.attach=function(e){var t={plugin:e,"force-bundle":!0,"force-rtcp-mux":!0};return this.session.send("attach",t).then(e=>(this.id=e.data.id,e))},n.prototype.detach=function(){return this.send("detach")},n.prototype.on=function(e,t){return this.session.on(e,e=>{e.sender==this.id&&t(e)})},n.prototype.send=function(e,t){return this.session.send(e,Object.assign({handle_id:this.id},t))},n.prototype.sendMessage=function(e){return this.send("message",{body:e})},n.prototype.sendJsep=function(e){return this.send("message",{body:{},jsep:e})},n.prototype.sendTrickle=function(e){return this.send("trickle",{candidate:e})},s.prototype.create=function(){return this.send("create").then(e=>(this.id=e.data.id,e))},s.prototype.destroy=function(){return this.send("destroy").then(e=>(this.dispose(),e))},s.prototype.dispose=function(){for(var e in this._killKeepalive(),this.eventHandlers={},this.txns)if(this.txns.hasOwnProperty(e)){var t=this.txns[e];clearTimeout(t.timeout),t.reject(new Error("Janus session was disposed.")),delete this.txns[e]}},s.prototype.isError=function(e){return"error"===e.janus},s.prototype.on=function(e,t){var n=this.eventHandlers[e];null==n&&(n=this.eventHandlers[e]=[]),n.push(t)},s.prototype.receive=function(e){this.options.verbose&&this._logIncoming(e),e.session_id!=this.id&&console.warn("Incorrect session ID received in Janus signalling message: was "+e.session_id+", expected "+this.id+".");var t=e.janus,n=this.eventHandlers[t];if(null!=n)for(var s=0;s<n.length;s++)n[s](e);if(null!=e.transaction){var i=this.txns[e.transaction];if(null==i)return;if("ack"===t&&"message"==i.type)return;clearTimeout(i.timeout),delete this.txns[e.transaction],(this.isError(e)?i.reject:i.resolve)(e)}},s.prototype.send=function(e,t){return t=Object.assign({transaction:(this.nextTxId++).toString()},t),new Promise((n,s)=>{var i=null;this.options.timeoutMs&&(i=setTimeout(()=>{delete this.txns[t.transaction],s(new Error("Signalling transaction with txid "+t.transaction+" timed out."))},this.options.timeoutMs)),this.txns[t.transaction]={resolve:n,reject:s,timeout:i,type:e},this._transmit(e,t)})},s.prototype._transmit=function(e,t){t=Object.assign({janus:e},t),null!=this.id&&(t=Object.assign({session_id:this.id},t)),this.options.verbose&&this._logOutgoing(t),this.output(JSON.stringify(t)),this._resetKeepalive()},s.prototype._logOutgoing=function(e){var t=e.janus;"message"===t&&e.jsep&&(t=e.jsep.type);var n="> Outgoing Janus "+(t||"signal")+" (#"+e.transaction+"): ";console.debug("%c"+n,"color: #040",e)},s.prototype._logIncoming=function(e){var t=e.janus,n=e.transaction?"< Incoming Janus "+(t||"signal")+" (#"+e.transaction+"): ":"< Incoming Janus "+(t||"signal")+": ";console.debug("%c"+n,"color: #004",e)},s.prototype._sendKeepalive=function(){return this.send("keepalive")},s.prototype._killKeepalive=function(){clearTimeout(this.keepaliveTimeout)},s.prototype._resetKeepalive=function(){this._killKeepalive(),this.options.keepaliveMs&&(this.keepaliveTimeout=setTimeout(()=>{this._sendKeepalive().catch(e=>console.error("Error received from keepalive: ",e))},this.options.keepaliveMs))},e.exports={JanusPluginHandle:n,JanusSession:s}},function(e,t,n){function s(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function s(i,r){try{var o=t[i](r),a=o.value}catch(e){return void n(e)}if(!o.done)return Promise.resolve(a).then(function(e){s("next",e)},function(e){s("throw",e)});e(a)}("next")})}}var i=n(4),r=n(0)("naf-janus-adapter:debug"),o=(n(0)("naf-janus-adapter:warn"),n(0)("naf-janus-adapter:error"));function a(e){var t=Promise.resolve();return function(){var n=Array.prototype.slice.call(arguments);t=t.then(t=>e.apply(this,n))}}const c=""!==document.createElement("video").canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"'),u={iceServers:[{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}]},d=1e3;class l{constructor(){this.room=null,this.userId=String(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)),this.serverUrl=null,this.webRtcOptions={},this.ws=null,this.session=null,this.initialReconnectionDelay=1e3*Math.random(),this.reconnectionDelay=this.initialReconnectionDelay,this.reconnectionTimeout=null,this.maxReconnectionAttempts=10,this.reconnectionAttempts=0,this.publisher=null,this.occupants={},this.mediaStreams={},this.localMediaStream=null,this.pendingMediaRequests=new Map,this.frozenUpdates=new Map,this.timeOffsets=[],this.serverTimeRequests=0,this.avgTimeOffset=0,this.onWebsocketOpen=this.onWebsocketOpen.bind(this),this.onWebsocketClose=this.onWebsocketClose.bind(this),this.onWebsocketMessage=this.onWebsocketMessage.bind(this),this.onDataChannelMessage=this.onDataChannelMessage.bind(this)}setServerUrl(e){this.serverUrl=e}setApp(e){}setRoom(e){this.room=e}setWebRtcOptions(e){this.webRtcOptions=e}setServerConnectListeners(e,t){this.connectSuccess=e,this.connectFailure=t}setRoomOccupantListener(e){this.onOccupantsChanged=e}setDataChannelListeners(e,t,n){this.onOccupantConnected=e,this.onOccupantDisconnected=t,this.onOccupantMessage=n}setReconnectionListeners(e,t,n){this.onReconnecting=e,this.onReconnected=t,this.onReconnectionError=n}connect(){r(`connecting to ${this.serverUrl}`);const e=new Promise((e,t)=>{let n;this.ws=new WebSocket(this.serverUrl,"janus-protocol"),this.session=new i.JanusSession(this.ws.send.bind(this.ws));const s=()=>{t(o)};this.ws.addEventListener("close",this.onWebsocketClose),this.ws.addEventListener("message",this.onWebsocketMessage),n=(()=>{this.ws.removeEventListener("open",n),this.ws.removeEventListener("error",s),this.onWebsocketOpen().then(e).catch(t)}),this.ws.addEventListener("open",n)});return Promise.all([e,this.updateTimeOffset()])}disconnect(){r("disconnecting"),clearTimeout(this.reconnectionTimeout),this.removeAllOccupants(),this.publisher&&(this.publisher.conn.close(),this.publisher=null),this.session&&(this.session.dispose(),this.session=null),this.ws&&(this.ws.removeEventListener("open",this.onWebsocketOpen),this.ws.removeEventListener("close",this.onWebsocketClose),this.ws.removeEventListener("message",this.onWebsocketMessage),this.ws.close(),this.ws=null)}isDisconnected(){return null===this.ws}onWebsocketOpen(){var e=this;return s(function*(){yield e.session.create(),e.publisher=yield e.createPublisher(),e.connectSuccess(e.userId),yield Promise.all(e.publisher.initialOccupants.map(e.addOccupant.bind(e)))})()}onWebsocketClose(e){e.code!==d&&(this.onReconnecting&&this.onReconnecting(this.reconnectionDelay),this.reconnectionTimeout=setTimeout(()=>this.reconnect(),this.reconnectionDelay))}reconnect(){this.disconnect(),this.connect().then(()=>{this.reconnectionDelay=this.initialReconnectionDelay,this.reconnectionAttempts=0,this.onReconnected&&this.onReconnected()}).catch(e=>{if(this.reconnectionDelay+=1e3,this.reconnectionAttempts++,this.reconnectionAttempts>this.maxReconnectionAttempts&&this.onReconnectionError)return this.onReconnectionError(new Error("Connection could not be reestablished, exceeded maximum number of reconnection attempts."));this.onReconnecting&&this.onReconnecting(this.reconnectionDelay),this.reconnectionTimeout=setTimeout(()=>this.reconnect(),this.reconnectionDelay)})}onWebsocketMessage(e){this.session.receive(JSON.parse(e.data))}addOccupant(e){var t=this;return s(function*(){var n=yield t.createSubscriber(e);return t.occupants[e]=n,t.setMediaStream(e,n.mediaStream),t.onOccupantConnected(e),t.onOccupantsChanged(t.occupants),n})()}removeAllOccupants(){for(const e of Object.getOwnPropertyNames(this.occupants))this.removeOccupant(e)}removeOccupant(e){if(this.occupants[e]){if(this.occupants[e]&&(this.occupants[e].conn.close(),delete this.occupants[e]),this.mediaStreams[e]&&delete this.mediaStreams[e],this.pendingMediaRequests.has(e)){const t="The user disconnected before the media stream was resolved.";this.pendingMediaRequests.get(e).audio.reject(t),this.pendingMediaRequests.get(e).video.reject(t),this.pendingMediaRequests.delete(e)}this.onOccupantDisconnected(e),this.onOccupantsChanged(this.occupants)}}associate(e,t){e.addEventListener("icecandidate",e=>{t.sendTrickle(e.candidate||null).catch(e=>o("Error trickling ICE: %o",e))}),e.addEventListener("negotiationneeded",a(n=>{r("Sending new offer for handle: %o",t);var s=e.createOffer(),i=s.then(t=>e.setLocalDescription(t)),a=s.then(e=>t.sendJsep(e)).then(t=>e.setRemoteDescription(t.jsep));return Promise.all([i,a]).catch(e=>o("Error negotiating offer: %o",e))})),t.on("event",a(n=>{var s=n.jsep;if(s&&"offer"==s.type){r("Accepting new offer for handle: %o",t),s.sdp=this.configureSubscriberSdp(s.sdp);var i=e.setRemoteDescription(s).then(t=>e.createAnswer()),a=i.then(t=>e.setLocalDescription(t)),c=i.then(e=>t.sendJsep(e));Promise.all([a,c]).catch(e=>o("Error negotiating answer: %o",e))}}))}createPublisher(){var e=this;return s(function*(){var t=new i.JanusPluginHandle(e.session),n=new RTCPeerConnection(u);r("pub waiting for sfu"),yield t.attach("janus.plugin.sfu");var s=n.createDataChannel("reliable",{ordered:!0}),o=n.createDataChannel("unreliable",{ordered:!1,maxRetransmits:0});s.addEventListener("message",e.onDataChannelMessage),o.addEventListener("message",e.onDataChannelMessage),e.associate(n,t),r("pub waiting for webrtcup"),yield new Promise(function(e){return t.on("webrtcup",e)}),e.localMediaStream&&e.localMediaStream.getTracks().forEach(function(t){n.addTrack(t,e.localMediaStream)}),t.on("event",function(t){var n=t.plugindata.data;"join"==n.event&&n.room_id==e.room?e.addOccupant(n.user_id):"leave"==n.event&&n.room_id==e.room?e.removeOccupant(n.user_id):"blocked"==n.event?document.body.dispatchEvent(new CustomEvent("blocked",{detail:{clientId:n.by}})):"unblocked"==n.event&&document.body.dispatchEvent(new CustomEvent("unblocked",{detail:{clientId:n.by}}))}),r("pub waiting for join");var a=yield e.sendJoin(t,{notifications:!0,data:!0});if(!a.plugindata.data.success){const e=a.plugindata.data.error;throw console.error(e),e}var c=a.plugindata.data.response.users[e.room]||[];return r("publisher ready"),{handle:t,initialOccupants:c,reliableChannel:s,unreliableChannel:o,conn:n}})()}configureSubscriberSdp(e){return c?-1===navigator.userAgent.indexOf("Android")?e.replace("a=rtcp-fb:107 goog-remb\r\n","a=rtcp-fb:107 goog-remb\r\na=rtcp-fb:107 transport-cc\r\na=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\n"):e.replace("a=rtcp-fb:107 goog-remb\r\n","a=rtcp-fb:107 goog-remb\r\na=rtcp-fb:107 transport-cc\r\na=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\r\n"):-1!==navigator.userAgent.indexOf("HeadlessChrome")?e.replace(/m=video[^]*m=/,"m="):e}createSubscriber(e){var t=this;return s(function*(){var n=new i.JanusPluginHandle(t.session),s=new RTCPeerConnection(u);r("sub waiting for sfu"),yield n.attach("janus.plugin.sfu"),t.associate(s,n),r("sub waiting for join");yield t.sendJoin(n,{media:e});r("sub waiting for webrtcup"),yield new Promise(function(e){return n.on("webrtcup",e)});var o=new MediaStream;return s.getReceivers().forEach(function(e){e.track&&o.addTrack(e.track)}),0===o.getTracks().length&&(o=null),r("subscriber ready"),{handle:n,mediaStream:o,conn:s}})()}sendJoin(e,t){return e.sendMessage({kind:"join",room_id:this.room,user_id:this.userId,subscribe:t})}toggleFreeze(){this.frozen?this.unfreeze():this.freeze()}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1,this.flushPendingUpdates()}flushPendingUpdates(){for(const[e,t]of this.frozenUpdates)t.data.owner&&!this.occupants[t.data.owner]||this.onOccupantMessage(null,t.dataType,t.data);this.frozenUpdates.clear()}storeMessage(e){const t=e.data.networkId;if(this.frozenUpdates.has(t)){const n=this.frozenUpdates.get(t);if(e.data.lastOwnerTime<n.data.lastOwnerTime||n.data.lastOwnerTime===e.data.lastOwnerTime&&n.data.owner>e.data.owner)return;"r"===e.dataType?this.frozenUpdates.set(t,e):Object.assign(n.data.components,e.data.components)}else this.frozenUpdates.set(t,e)}onDataChannelMessage(e){var t=JSON.parse(e.data);t.dataType&&(this.frozen?this.storeMessage(t):this.onOccupantMessage(null,t.dataType,t.data))}shouldStartConnectionTo(e){return!0}startStreamConnection(e){}closeStreamConnection(e){}getConnectStatus(e){return this.occupants[e]?NAF.adapters.IS_CONNECTED:NAF.adapters.NOT_CONNECTED}updateTimeOffset(){var e=this;return s(function*(){if(e.isDisconnected())return;const t=Date.now(),n=yield fetch(document.location.href,{method:"HEAD",cache:"no-cache"}),s=new Date(n.headers.get("Date")).getTime()+500,i=Date.now(),o=s+(i-t)/2-i;e.serverTimeRequests++,e.serverTimeRequests<=10?e.timeOffsets.push(o):e.timeOffsets[e.serverTimeRequests%10]=o,e.avgTimeOffset=e.timeOffsets.reduce(function(e,t){return e+t},0)/e.timeOffsets.length,e.serverTimeRequests>10?(r(`new server time offset: ${e.avgTimeOffset}ms`),setTimeout(function(){return e.updateTimeOffset()},3e5)):e.updateTimeOffset()})()}getServerTime(){return Date.now()+this.avgTimeOffset}getMediaStream(e,t="audio"){if(this.mediaStreams[e])return r(`Already had ${t} for ${e}`),Promise.resolve(this.mediaStreams[e][t]);if(r(`Waiting on ${t} for ${e}`),!this.pendingMediaRequests.has(e)){this.pendingMediaRequests.set(e,{});const t=new Promise((t,n)=>{this.pendingMediaRequests.get(e).audio={resolve:t,reject:n}}),n=new Promise((t,n)=>{this.pendingMediaRequests.get(e).video={resolve:t,reject:n}});this.pendingMediaRequests.get(e).audio.promise=t,this.pendingMediaRequests.get(e).video.promise=n}return this.pendingMediaRequests.get(e)[t].promise}setMediaStream(e,t){const n=new MediaStream;t.getAudioTracks().forEach(e=>n.addTrack(e));const s=new MediaStream;t.getVideoTracks().forEach(e=>s.addTrack(e)),this.mediaStreams[e]={audio:n,video:s},this.pendingMediaRequests.has(e)&&(this.pendingMediaRequests.get(e).audio.resolve(n),this.pendingMediaRequests.get(e).video.resolve(s))}setLocalMediaStream(e){if(this.publisher&&this.publisher.conn){var t=this.publisher.conn.getSenders(),n=[];e.getTracks().forEach(s=>{var i=t.find(e=>null!=e.track&&e.track.kind==s.kind);null!=i?(i.replaceTrack?(i.replaceTrack(s),i.track.enabled=!0):(e.removeTrack(i.track),e.addTrack(s),s.enabled=!0),n.push(i)):n.push(this.publisher.conn.addTrack(s,e))}),t.forEach(e=>{n.includes(e)||(e.track.enabled=!1)})}this.localMediaStream=e,this.setMediaStream(this.userId,e)}enableMicrophone(e){this.publisher&&this.publisher.conn&&this.publisher.conn.getSenders().forEach(t=>{"audio"==t.track.kind&&(t.track.enabled=e)})}sendData(e,t,n){if(!this.publisher)return console.warn("sendData called without a publisher");this.publisher.unreliableChannel.send(JSON.stringify({clientId:e,dataType:t,data:n}))}sendDataGuaranteed(e,t,n){if(!this.publisher)return console.warn("sendDataGuaranteed called without a publisher");this.publisher.reliableChannel.send(JSON.stringify({clientId:e,dataType:t,data:n}))}broadcastData(e,t){if(!this.publisher)return console.warn("broadcastData called without a publisher");this.publisher.unreliableChannel.send(JSON.stringify({dataType:e,data:t}))}broadcastDataGuaranteed(e,t){if(!this.publisher)return console.warn("broadcastDataGuaranteed called without a publisher");this.publisher.reliableChannel.send(JSON.stringify({dataType:e,data:t}))}block(e){return this.publisher.handle.sendMessage({kind:"block",whom:e}).then(()=>{document.body.dispatchEvent(new CustomEvent("blocked",{detail:{clientId:e}}))})}unblock(e){return this.publisher.handle.sendMessage({kind:"unblock",whom:e}).then(()=>{document.body.dispatchEvent(new CustomEvent("unblocked",{detail:{clientId:e}}))})}}NAF.adapters.register("janus",l),e.exports=l}]);
>>>>>>> Update build to use webpack 4
//# sourceMappingURL=naf-janus-adapter.min.js.map